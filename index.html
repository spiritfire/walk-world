<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å¥èº«æ¼«æ­¥ V4 - ç‰©ç†å¼•æ“ç‰ˆ</title>
    <style>
        /* --- åŸºç¡€æ ·å¼ --- */
        body, html {
            margin: 0; padding: 0; width: 100%; height: 100%;
            background-color: #000; overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, Roboto, sans-serif;
            color: white; user-select: none; -webkit-tap-highlight-color: transparent;
        }

        /* è§†é¢‘å®¹å™¨ */
        #video-container {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 1; overflow: hidden; display: flex; align-items: center; justify-content: center;
        }
        video {
            /* é»˜è®¤çŠ¶æ€ï¼ŒJSä¼šæ ¹æ®VRæ¨¡å¼è°ƒæ•´ */
            width: 100%; height: 100%; object-fit: cover;
            transform-origin: center center;
            will-change: transform;
        }

        /* UI è¦†ç›–å±‚ */
        #hud-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 10; pointer-events: none;
            display: flex; flex-direction: column; justify-content: space-between;
        }

        /* é¡¶éƒ¨ä»ªè¡¨ç›˜ */
        .top-panel {
            padding: 20px;
            background: linear-gradient(to bottom, rgba(0,0,0,0.8), transparent);
            display: flex; justify-content: space-between; align-items: flex-start;
        }
        .metric { text-align: left; }
        .metric-right { text-align: right; }
        .big-num { font-size: 32px; font-weight: 800; font-variant-numeric: tabular-nums; text-shadow: 0 2px 4px black; }
        .label { font-size: 12px; color: #ccc; text-transform: uppercase; margin-top: -2px; }
        .sub-val { font-size: 14px; color: #4CAF50; font-weight: bold; margin-top: 2px; }

        /* åº•éƒ¨æ§åˆ¶æ  */
        .bottom-panel {
            padding: 20px; padding-bottom: 30px;
            background: linear-gradient(to top, rgba(0,0,0,0.9), transparent);
            pointer-events: auto;
        }

        /* è¿›åº¦æ¡ */
        .progress-bg {
            width: 100%; height: 6px; background: rgba(255,255,255,0.2);
            border-radius: 3px; margin-bottom: 15px; position: relative; overflow: hidden;
        }
        .progress-fg {
            height: 100%; width: 0%; background: #4CAF50;
            box-shadow: 0 0 10px #4CAF50; transition: width 0.2s linear;
        }
        .progress-text {
            position: absolute; right: 0; top: -20px; font-size: 12px; color: #aaa;
        }

        /* è®¾ç½®é¢æ¿ (æŠ½å±‰å¼) */
        #settings-drawer {
            position: absolute; bottom: 0; left: 0; width: 100%;
            background: #1e1e1e; border-top-left-radius: 20px; border-top-right-radius: 20px;
            padding: 20px; box-sizing: border-box;
            transform: translateY(110%); transition: transform 0.3s cubic-bezier(0.1, 0.7, 0.1, 1);
            z-index: 20; pointer-events: auto; max-height: 80vh; overflow-y: auto;
            border-top: 1px solid #333;
        }
        #settings-drawer.open { transform: translateY(0); }

        /* æ§ä»¶æ ·å¼ */
        .row { margin-bottom: 18px; }
        .row-header { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 14px; color: #ddd; }
        .row-val { color: #4CAF50; font-weight: bold; }
        input[type="range"] {
            width: 100%; height: 6px; background: #444; border-radius: 3px;
            -webkit-appearance: none; outline: none;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none; width: 22px; height: 22px; background: #fff; border-radius: 50%;
            box-shadow: 0 2px 5px rgba(0,0,0,0.5);
        }
        .toggle-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px; }
        .toggle-switch {
            width: 50px; height: 28px; background: #444; border-radius: 14px; position: relative; transition: 0.3s; cursor: pointer;
        }
        .toggle-switch::after {
            content: ''; position: absolute; top: 2px; left: 2px; width: 24px; height: 24px;
            background: white; border-radius: 50%; transition: 0.3s;
        }
        .toggle-switch.active { background: #4CAF50; }
        .toggle-switch.active::after { left: 24px; }

        /* æŒ‰é’® */
        button { border: none; outline: none; }
        .btn-main {
            width: 100%; background: #333; color: white; padding: 12px; border-radius: 10px;
            font-size: 14px; font-weight: bold; margin-top: 10px;
        }
        .btn-start {
            background: linear-gradient(135deg, #4CAF50, #2E7D32);
            color: white; padding: 15px 40px; border-radius: 30px; font-size: 18px;
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.4);
        }
        
        /* å¯åŠ¨é¡µ */
        #start-page {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 50; display: flex; flex-direction: column;
            align-items: center; justify-content: center; text-align: center;
        }
    </style>
</head>
<body>

    <!-- å¯åŠ¨é¡µ -->
    <div id="start-page">
        <h1 style="color:#4CAF50; margin-bottom:5px;">ğŸƒ æ¼«æ­¥ V4</h1>
        <p style="color:#666; font-size:12px; margin-bottom:40px;">ç‰©ç†è®¡ç®— Â· æ²‰æµ¸åé¦ˆ Â· VRå…¨æ™¯</p>
        
        <button class="btn-main" onclick="document.getElementById('videoInput').click()" style="width:auto; padding:10px 30px; margin-bottom:20px; background:#2196F3;">
            ğŸ“‚ 1. é€‰æ‹©è·¯çº¿è§†é¢‘
        </button>
        <input type="file" id="videoInput" accept="video/*" style="display:none" onchange="fileLoaded(this)">
        
        <div id="file-name" style="color:#4CAF50; font-size:12px; height:20px; margin-bottom:20px;"></div>

        <button id="btn-go" class="btn-start" onclick="initApp()" disabled style="opacity:0.5">
            ğŸš€ 2. å…¨å±å‡ºå‘
        </button>
    </div>

    <!-- è§†é¢‘å±‚ -->
    <div id="video-container">
        <video id="mainVideo" playsinline loop muted webkit-playsinline></video>
    </div>

    <!-- HUD ç•Œé¢ -->
    <div id="hud-layer" style="display:none;">
        <div class="top-panel">
            <div class="metric">
                <div class="big-num" id="disp-speed">0.0</div>
                <div class="label">æ’­æ”¾å€é€Ÿ (x)</div>
                <div class="sub-val" id="disp-kmh">0.0 km/h</div>
            </div>
            <div class="metric-right">
                <div class="big-num" id="disp-steps">0</div>
                <div class="label">æ€»æ­¥æ•°</div>
                <div class="sub-val" id="disp-dist">0.00 km</div>
            </div>
        </div>

        <div class="bottom-panel">
            <div class="progress-text"><span id="time-current">00:00</span> / <span id="time-total">00:00</span></div>
            <div class="progress-bg">
                <div class="progress-fg" id="progress-bar"></div>
            </div>
            <button class="btn-main" onclick="toggleSettings()">âš™ï¸ è¿åŠ¨è®¾ç½® & åé¦ˆ</button>
        </div>
    </div>

    <!-- è®¾ç½®æŠ½å±‰ -->
    <div id="settings-drawer">
        <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
            <h3>âš™ï¸ å‚æ•°è®¾ç½®</h3>
            <button onclick="toggleSettings()" style="background:transparent; color:#888; font-size:20px;">âœ•</button>
        </div>

        <!-- 1. åŸºç¡€ç‰©ç†å‚æ•° -->
        <div class="row">
            <div class="row-header">
                <span>åŸè§†é¢‘è¡Œè¿›é€Ÿåº¦ (km/h)</span>
                <span class="row-val" id="val-base">5</span>
            </div>
            <input type="range" min="2" max="30" value="5" oninput="updateParam('baseSpeed', this.value, 'val-base')">
        </div>

        <div class="row">
            <div class="row-header">
                <span>æˆ‘çš„æ­¥é•¿ (ç±³)</span>
                <span class="row-val" id="val-stride">0.70</span>
            </div>
            <input type="range" min="0.3" max="1.2" step="0.05" value="0.7" oninput="updateParam('strideLength', this.value, 'val-stride')">
            <div style="font-size:10px; color:#666; margin-top:5px;">è®¡ç®—å…¬å¼ï¼šæ­¥é¢‘ Ã— æ­¥é•¿ = å½“å‰é€Ÿåº¦</div>
        </div>

        <!-- 2. ä¼ æ„Ÿå™¨ä¸VR -->
        <div class="row">
            <div class="row-header">
                <span>ä¼ æ„Ÿå™¨çµæ•åº¦ (1=æçµæ•)</span>
                <span class="row-val" id="val-sens">1.5</span>
            </div>
            <input type="range" min="1.0" max="6.0" step="0.1" value="1.5" oninput="updateParam('sensitivity', this.value, 'val-sens')">
        </div>

        <!-- 3. åé¦ˆå¼€å…³ -->
        <div class="toggle-row" onclick="toggleSwitch('sound')">
            <span>ğŸ”Š è¸æ­¥éŸ³æ•ˆ</span>
            <div class="toggle-switch active" id="sw-sound"></div>
        </div>
        <div class="toggle-row" onclick="toggleSwitch('vib')">
            <span>ğŸ“³ éœ‡åŠ¨åé¦ˆ</span>
            <div class="toggle-switch active" id="sw-vib"></div>
        </div>

        <div style="margin-top:20px; border-top:1px solid #333; padding-top:10px;">
            <button class="btn-main" style="background:#444;" onclick="simulateStep()">ğŸ§ª æ¨¡æ‹Ÿèµ°ä¸€æ­¥ (è°ƒè¯•ç”¨)</button>
        </div>
    </div>

    <script>
        // --- æ ¸å¿ƒé…ç½®ä¸çŠ¶æ€ ---
        const config = {
            baseSpeed: 5,       // è§†é¢‘å½•åˆ¶é€Ÿåº¦ km/h
            strideLength: 0.7,  // ç”¨æˆ·æ­¥é•¿ (ç±³)
            sensitivity: 1.5,   // ä¼ æ„Ÿå™¨é˜ˆå€¼
            soundEnabled: true,
            vibEnabled: true,
            vrMaxAngle: 30      // VRå·¦å³æœ€å¤§æ‘†åŠ¨è§’åº¦
        };

        const state = {
            isPlaying: false,
            steps: 0,
            lastStepTime: 0,
            currentCadence: 0,  // å½“å‰æ­¥é¢‘ (æ­¥/ç§’)
            targetRate: 0,      // ç›®æ ‡æ’­æ”¾å€ç‡
            currentRate: 0,     // å½“å‰å®é™…å€ç‡ (ç”¨äºå¹³æ»‘è¿‡æ¸¡)
            totalDistance: 0,   // æ€»é‡Œç¨‹ (km)
            vrInitialAlpha: null,
            isLandscape: false
        };

        // --- DOM å…ƒç´  ---
        const video = document.getElementById('mainVideo');
        const hud = document.getElementById('hud-layer');
        const drawer = document.getElementById('settings-drawer');
        const startPage = document.getElementById('start-page');
        
        // --- éŸ³é¢‘ä¸Šä¸‹æ–‡ (Web Audio API) ---
        let audioCtx;

        // --- 1. åˆå§‹åŒ– ---
        function fileLoaded(input) {
            const file = input.files[0];
            if (file) {
                video.src = URL.createObjectURL(file);
                document.getElementById('file-name').innerText = file.name;
                const btn = document.getElementById('btn-go');
                btn.disabled = false;
                btn.style.opacity = 1;

                // è§†é¢‘å…ƒæ•°æ®åŠ è½½ååˆ¤æ–­VRæ¨¡å¼
                video.onloadedmetadata = () => {
                    state.isLandscape = video.videoWidth > video.videoHeight;
                    if(state.isLandscape) {
                        // æ¨ªå±è§†é¢‘åœ¨ç«–å±æ‰‹æœºï¼šé«˜åº¦é“ºæ»¡ï¼Œå·¦å³æº¢å‡ºï¼Œå¼€å¯VR
                        video.style.height = "100vh";
                        video.style.width = "auto";
                        // é¢„å…ˆæ”¾å¤§ä¸€ç‚¹ï¼Œé¿å…ç§»åŠ¨æ—¶éœ²åº•
                        video.style.transform = "scale(1.2)";
                    } else {
                        // ç«–å±è§†é¢‘ï¼šå…¨å±è¦†ç›–
                        video.style.width = "100%";
                        video.style.height = "100%";
                    }
                };
            }
        }

        function initApp() {
            // åˆå§‹åŒ–éŸ³é¢‘ (å¿…é¡»åœ¨ç”¨æˆ·ç‚¹å‡»å)
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            
            // å…¨å±
            if(document.documentElement.requestFullscreen) document.documentElement.requestFullscreen();
            
            startPage.style.display = 'none';
            hud.style.display = 'flex';

            // è¯·æ±‚ä¼ æ„Ÿå™¨æƒé™
            if (typeof DeviceMotionEvent !== 'undefined' && typeof DeviceMotionEvent.requestPermission === 'function') {
                DeviceMotionEvent.requestPermission().then(res => {
                    if(res === 'granted') startSensors();
                    else alert("æ‹’ç»æƒé™å°†æ— æ³•æ£€æµ‹æ­¥æ•°");
                });
            } else {
                startSensors();
            }

            // é¢„æ’­æ”¾
            video.play().then(() => {
                video.pause(); // å…ˆæš‚åœï¼Œç­‰å¾…èµ°è·¯è§¦å‘
            }).catch(e => console.log(e));

            // å¯åŠ¨ä¸»å¾ªç¯
            state.isPlaying = true;
            requestAnimationFrame(gameLoop);
        }

        // --- 2. ä¼ æ„Ÿå™¨é€»è¾‘ ---
        function startSensors() {
            window.addEventListener('devicemotion', handleMotion);
            window.addEventListener('deviceorientation', handleOrientation);
        }

        function handleMotion(e) {
            const acc = e.accelerationIncludingGravity || e.acceleration;
            if (!acc) return;

            // è®¡ç®—å»é‡åŠ›åçš„åˆåŠ›
            const total = Math.sqrt(acc.x**2 + acc.y**2 + acc.z**2);
            const delta = Math.abs(total - 9.8); // å‡å»é‡åŠ›

            if (delta > config.sensitivity) {
                registerStep();
            }
        }

        // æ ¸å¿ƒï¼šè®°å½•ä¸€æ­¥
        function registerStep() {
            const now = Date.now();
            // é˜²æŠ–ï¼šæœ€å°é—´éš” 250ms (ç›¸å½“äºæœ€é«˜æ­¥é¢‘ 240/min)
            if (now - state.lastStepTime > 250) {
                // è®¡ç®—ç¬æ—¶æ­¥é¢‘
                let timeDiff = now - state.lastStepTime;
                
                // å¦‚æœé—´éš”å¤ªä¹…(æ¯”å¦‚åœä¸‹æ¥äº†)ï¼Œé‡ç½®è®¡ç®—
                if (timeDiff > 2000) timeDiff = 1000; // é»˜è®¤ç»™ä¸€ä¸ªåˆå§‹å€¼

                // æ›´æ–°çŠ¶æ€
                state.lastStepTime = now;
                state.steps++;
                
                // åé¦ˆ
                provideFeedback();

                // æ ¸å¿ƒè®¡ç®—ï¼šæ ¹æ®é—´éš”ç®—å‡º æ­¥/ç§’
                // timeDiff æ˜¯æ¯«ç§’ã€‚ 1000 / 500ms = 2 steps/sec
                const stepsPerSec = 1000 / timeDiff;
                
                calculateSpeed(stepsPerSec);
            }
        }

        function calculateSpeed(cadence) {
            // é€Ÿåº¦(m/s) = æ­¥é¢‘(æ­¥/s) * æ­¥é•¿(m)
            const speedMs = cadence * config.strideLength;
            
            // é€Ÿåº¦(km/h) = é€Ÿåº¦(m/s) * 3.6
            const speedKmh = speedMs * 3.6;

            // æ’­æ”¾å€ç‡ = å½“å‰é€Ÿåº¦ / åŸè§†é¢‘é€Ÿåº¦
            const rate = speedKmh / config.baseSpeed;

            // è®¾ç½®ç›®æ ‡å€ç‡ (é™åˆ¶åœ¨ 0.1 åˆ° 5.0 ä¹‹é—´)
            state.targetRate = Math.min(Math.max(rate, 0), 5.0);
        }

        // åé¦ˆç³»ç»Ÿ
        function provideFeedback() {
            // 1. éœ‡åŠ¨
            if (config.vibEnabled && navigator.vibrate) {
                navigator.vibrate(15); // çŸ­éœ‡åŠ¨
            }
            // 2. å£°éŸ³
            if (config.soundEnabled && audioCtx && audioCtx.state === 'running') {
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                osc.connect(gain);
                gain.connect(audioCtx.destination);
                
                // æ¨¡æ‹Ÿä½æ²‰çš„è„šæ­¥å£° (é¢‘ç‡å¿«é€Ÿä¸‹é™)
                osc.frequency.setValueAtTime(150, audioCtx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.15);
                
                gain.gain.setValueAtTime(0.3, audioCtx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.15);
                
                osc.start();
                osc.stop(audioCtx.currentTime + 0.15);
            }
        }

        // VR è§†è§’æ§åˆ¶
        function handleOrientation(e) {
            if (!state.isLandscape || !e.alpha) return;

            if (state.vrInitialAlpha === null) {
                state.vrInitialAlpha = e.alpha;
            }

            // è®¡ç®—è§’åº¦å·® (-180 ~ 180)
            let diff = e.alpha - state.vrInitialAlpha;
            if (diff > 180) diff -= 360;
            if (diff < -180) diff += 360;

            // ä¿®æ­£æ–¹å‘ï¼šäººå‘å·¦è½¬(diffè´Ÿ)ï¼Œç”»é¢åº”è¯¥å‘å³ç§»(translateXæ­£)ï¼Œæ‰èƒ½çœ‹åˆ°å·¦è¾¹çš„æ™¯
            // æ‰€ä»¥è¿™é‡Œç”¨ -diff
            // é™åˆ¶æœ€å¤§è§’åº¦ (Clamp)
            let clampedDiff = Math.max(-config.vrMaxAngle, Math.min(config.vrMaxAngle, -diff));

            // æ˜ å°„åˆ°ç™¾åˆ†æ¯” (å‡è®¾30åº¦å¯¹åº”20%ä½ç§»)
            let translatePct = (clampedDiff / config.vrMaxAngle) * 20;

            // åº”ç”¨å˜æ¢ï¼šä½ç§» + ç¼©æ”¾(é˜²æ­¢é»‘è¾¹)
            video.style.transform = `translateX(${translatePct}%) scale(1.2)`;
        }

        // --- 3. ä¸»å¾ªç¯ ---
        function gameLoop() {
            if (!state.isPlaying) return;

            const now = Date.now();

            // è‡ªåŠ¨åœè½¦é€»è¾‘ï¼šå¦‚æœè¶…è¿‡1.5ç§’æ²¡æœ‰æ–°æ­¥æ•°ï¼Œç›®æ ‡é€Ÿåº¦å½’é›¶
            if (now - state.lastStepTime > 1500) {
                state.targetRate = 0;
            }

            // å¹³æ»‘è¿‡æ¸¡ (Lerp)
            // 0.05 æ˜¯å¹³æ»‘ç³»æ•°ï¼Œè¶Šå°è¶Šå¹³æ»‘ä½†ååº”è¶Šæ…¢
            const diff = state.targetRate - state.currentRate;
            if (Math.abs(diff) > 0.01) {
                state.currentRate += diff * 0.05;
            } else {
                state.currentRate = state.targetRate;
            }

            // æ’­æ”¾æ§åˆ¶
            if (state.currentRate > 0.05) {
                video.playbackRate = state.currentRate;
                if (video.paused) {
                    video.play().catch(e => {}); // å¿½ç•¥æ’­æ”¾ä¸­çš„æ‰“æ–­é”™è¯¯
                }
            } else {
                // é€Ÿåº¦æä½æ—¶æš‚åœ
                state.currentRate = 0;
                if (!video.paused) video.pause();
            }

            // UI æ›´æ–°
            updateUI();

            requestAnimationFrame(gameLoop);
        }

        function updateUI() {
            // å€é€Ÿ
            document.getElementById('disp-speed').innerText = state.currentRate.toFixed(1);
            
            // å®æ—¶é€Ÿåº¦ (Rate * Base)
            const realKmh = state.currentRate * config.baseSpeed;
            document.getElementById('disp-kmh').innerText = realKmh.toFixed(1) + " km/h";

            // æ­¥æ•°
            document.getElementById('disp-steps').innerText = state.steps;

            // æ€»é‡Œç¨‹ (åˆ©ç”¨åŸè§†é¢‘æ—¶é—´è®¡ç®—å¤ªéº»çƒ¦ï¼Œç›´æ¥ç”¨ æ­¥æ•° * æ­¥é•¿ æ›´å‡†)
            const distKm = (state.steps * config.strideLength) / 1000;
            document.getElementById('disp-dist').innerText = distKm.toFixed(2) + " km";

            // è¿›åº¦æ¡ä¸æ—¶é—´
            if (video.duration) {
                const pct = (video.currentTime / video.duration) * 100;
                document.getElementById('progress-bar').style.width = pct + "%";
                document.getElementById('time-current').innerText = formatTime(video.currentTime);
                document.getElementById('time-total').innerText = formatTime(video.duration);
            }
        }

        // --- è¾…åŠ©åŠŸèƒ½ ---
        function updateParam(key, val, displayId) {
            val = parseFloat(val);
            config[key] = val;
            if (displayId) {
                document.getElementById(displayId).innerText = val.toFixed(key === 'baseSpeed' ? 0 : (key==='sensitivity'?1:2));
            }
        }

        function toggleSwitch(type) {
            if(type === 'sound') {
                config.soundEnabled = !config.soundEnabled;
                document.getElementById('sw-sound').classList.toggle('active');
            } else if (type === 'vib') {
                config.vibEnabled = !config.vibEnabled;
                document.getElementById('sw-vib').classList.toggle('active');
            }
        }

        function toggleSettings() {
            drawer.classList.toggle('open');
        }

        function simulateStep() {
            registerStep();
        }

        function formatTime(s) {
            const m = Math.floor(s / 60);
            const sec = Math.floor(s % 60);
            return `${m}:${sec < 10 ? '0'+sec : sec}`;
        }

        // è°ƒè¯•æ¨¡æ‹Ÿ
        window.simulateStep = simulateStep;

    </script>
</body>
</html>
