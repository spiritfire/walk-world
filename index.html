<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ¼«æ­¥ V8 - å®Œç¾èµ·æ­¥ç‰ˆ</title>
    <style>
        /* --- åŸºç¡€æ ·å¼ --- */
        body, html {
            margin: 0; padding: 0; width: 100%; height: 100%;
            background: #000; overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, Roboto, sans-serif;
            user-select: none; color: white; -webkit-tap-highlight-color: transparent;
        }

        /* è§†é¢‘å®¹å™¨ */
        #vid-box {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 1; display: flex; align-items: center; justify-content: center;
            overflow: hidden;
        }
        video {
            width: 100%; height: 100%; object-fit: cover;
            transition: transform 0.1s linear; /* ä»…VRä½ç§» */
        }

        /* UIå±‚ (å…¨é€æ˜ + å¼ºé˜´å½±) */
        #hud {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 10; pointer-events: none;
            display: flex; flex-direction: column; justify-content: space-between;
            text-shadow: 0 2px 4px rgba(0,0,0,0.9), 0 0 10px rgba(0,0,0,0.5);
        }

        /* é¡¶éƒ¨æ•°æ® */
        .hud-top {
            padding: 25px; display: flex; justify-content: space-between;
        }
        .grp { display: flex; flex-direction: column; }
        .grp-r { text-align: right; }
        
        .txt-lg { font-size: 52px; font-weight: 800; line-height: 0.9; font-variant-numeric: tabular-nums; }
        .txt-sm { font-size: 13px; font-weight: bold; color: #ddd; margin-top: 6px; text-transform: uppercase; }
        .txt-accent { font-size: 16px; color: #00e676; font-weight: bold; margin-top: 4px; }

        /* åº•éƒ¨æ§åˆ¶ */
        .hud-btm {
            padding: 25px; pointer-events: auto;
            display: flex; flex-direction: column; gap: 12px;
        }

        .bar-bg {
            width: 100%; height: 6px; background: rgba(255,255,255,0.3);
            border-radius: 3px; overflow: hidden; backdrop-filter: blur(4px);
        }
        .bar-fg {
            height: 100%; width: 0%; background: #00e676;
            box-shadow: 0 0 10px #00e676; transition: width 0.2s linear;
        }
        .time-info { text-align: right; font-size: 12px; opacity: 0.9; }

        /* è®¾ç½®æŠ½å±‰ */
        #drawer {
            position: absolute; bottom: 0; left: 0; width: 100%;
            background: rgba(10, 10, 10, 0.98);
            border-top: 1px solid #333; border-radius: 20px 20px 0 0;
            padding: 25px; box-sizing: border-box;
            transform: translateY(110%); transition: transform 0.3s cubic-bezier(0.19, 1, 0.22, 1);
            z-index: 20; pointer-events: auto; color: white;
        }
        #drawer.active { transform: translateY(0); }

        .set-row { margin-bottom: 25px; }
        .set-head { display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 14px; color: #aaa; }
        .set-val { color: #00e676; font-weight: bold; }
        
        input[type=range] { width: 100%; height: 4px; background: #444; border-radius: 2px; -webkit-appearance: none; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; width: 22px; height: 22px; background: #fff; border-radius: 50%; margin-top: -9px; box-shadow: 0 2px 5px black; }
        input[type=range]::-webkit-slider-runnable-track { height: 4px; background: #444; }

        /* å¯åŠ¨å± */
        #splash {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 100;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .btn {
            background: #222; border: 1px solid #555; color: white;
            padding: 14px 35px; border-radius: 50px; font-size: 16px; font-weight: bold;
            margin: 10px; cursor: pointer;
        }
        .btn-go { background: #00e676; color: black; border: none; }
        .btn-opt { background: transparent; border: 1px solid rgba(255,255,255,0.4); padding: 8px 16px; font-size: 12px; align-self: flex-end; backdrop-filter: blur(4px); }
    </style>
</head>
<body>

    <!-- å¯åŠ¨å± -->
    <div id="splash">
        <h1 style="color:#00e676; margin-bottom:10px;">ğŸƒ æ¼«æ­¥ V8</h1>
        <p style="color:#888; font-size:12px; margin-bottom:40px;">è§£å†³å¡æ­» Â· æé€Ÿå”¤é†’ Â· çŠ¶æ€æœº</p>
        
        <button class="btn" onclick="document.getElementById('fileIn').click()">1. é€‰æ‹©è§†é¢‘</button>
        <input type="file" id="fileIn" accept="video/*" style="display:none" onchange="onFileLoaded(this)">
        <div id="fName" style="color:#00e676; font-size:12px; height:20px; margin-bottom:20px;"></div>
        
        <button id="btnStart" class="btn btn-go" onclick="appStart()" disabled style="opacity:0.3">2. å…¨å±å¼€å§‹</button>
    </div>

    <!-- è§†é¢‘ -->
    <div id="vid-box">
        <video id="vid" playsinline loop muted webkit-playsinline></video>
    </div>

    <!-- HUD -->
    <div id="hud" style="display:none;">
        <div class="hud-top">
            <div class="grp">
                <div class="txt-lg" id="ui-spd">0.0</div>
                <div class="txt-sm">æ—¶é€Ÿ (km/h)</div>
                <div class="txt-accent" id="ui-rate">0.0 x</div>
            </div>
            <div class="grp grp-r">
                <div class="txt-lg" id="ui-step">0</div>
                <div class="txt-sm">æ­¥æ•°</div>
                <div class="txt-accent" id="ui-dist">0.00 km</div>
            </div>
        </div>

        <div class="hud-btm">
            <div class="time-info"><span id="t-cur">0:00</span> / <span id="t-all">0:00</span></div>
            <div class="bar-bg">
                <div class="bar-fg" id="p-bar"></div>
            </div>
            <button class="btn-opt" onclick="toggleDrawer()">âš™ï¸ è®¾ç½®</button>
        </div>
    </div>

    <!-- è®¾ç½® -->
    <div id="drawer">
        <div style="display:flex; justify-content:space-between; margin-bottom:25px;">
            <h3>å‚æ•°è°ƒæ•´</h3>
            <button onclick="toggleDrawer()" style="background:none; border:none; color:#666; font-size:24px;">Ã—</button>
        </div>

        <div class="set-row">
            <div class="set-head"><span>åŸè§†é¢‘é€Ÿåº¦</span><span class="set-val" id="v-base">5 km/h</span></div>
            <input type="range" min="2" max="20" value="5" oninput="setCfg('base',this.value)">
        </div>

        <div class="set-row">
            <div class="set-head"><span>æˆ‘çš„æ­¥é•¿</span><span class="set-val" id="v-stride">0.70 m</span></div>
            <input type="range" min="0.4" max="1.2" step="0.05" value="0.7" oninput="setCfg('stride',this.value)">
        </div>

        <div class="set-row">
            <div class="set-head"><span>çµæ•åº¦ (1.0=æçµæ•)</span><span class="set-val" id="v-sens">1.3</span></div>
            <input type="range" min="0.8" max="4.0" step="0.1" value="1.3" oninput="setCfg('sens',this.value)">
        </div>

        <div style="text-align:center; padding-top:10px; border-top:1px solid #333;">
            <button class="btn" style="font-size:12px; padding:10px 20px;" onclick="forceStep()">ğŸ§ª æ¨¡æ‹Ÿä¸€æ­¥ (å”¤é†’æµ‹è¯•)</button>
        </div>
    </div>

    <script>
        // --- æ ¸å¿ƒçŠ¶æ€æœº ---
        const cfg = {
            base: 5,       // åŸè§†é¢‘é€Ÿåº¦
            stride: 0.7,   // æ­¥é•¿
            sens: 1.3,     // é»˜è®¤çµæ•åº¦ (è°ƒä½äº†ï¼Œæ›´æ˜“è§¦å‘)
            vrMax: 25
        };

        const state = {
            active: false,
            steps: 0,
            
            // é€Ÿåº¦å¼•æ“ V8
            isIdle: true,     // å…³é”®æ ‡å¿—ï¼šæ˜¯å¦å¤„äºâ€œåœè½¦â€çŠ¶æ€
            lastT: 0,         // ä¸Šä¸€æ­¥æ—¶é—´
            hist: [],         // å†å²æ­¥é¢‘
            
            currRate: 0,
            targetRate: 0,
            
            isLandscape: false,
            baseAlpha: null
        };

        const vid = document.getElementById('vid');
        let audioCtx;

        // --- 1. å¯åŠ¨ ---
        function onFileLoaded(el) {
            const f = el.files[0];
            if(!f) return;
            vid.src = URL.createObjectURL(f);
            document.getElementById('fName').innerText = f.name;
            document.getElementById('btnStart').disabled = false;
            document.getElementById('btnStart').style.opacity = 1;
            
            vid.onloadedmetadata = () => {
                state.isLandscape = vid.videoWidth > vid.videoHeight;
                if(state.isLandscape) {
                    vid.style.width = 'auto'; vid.style.height = '100vh';
                } else {
                    vid.style.width = '100%'; vid.style.height = '100%';
                }
            };
        }

        function appStart() {
            if(document.documentElement.requestFullscreen) document.documentElement.requestFullscreen();
            document.getElementById('splash').style.display = 'none';
            document.getElementById('hud').style.display = 'flex';
            
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();

            if (typeof DeviceMotionEvent !== 'undefined' && typeof DeviceMotionEvent.requestPermission === 'function') {
                DeviceMotionEvent.requestPermission().then(r => { if(r==='granted') initSensors(); });
            } else {
                initSensors();
            }

            vid.play().then(() => vid.pause()).catch(()=>{});
            state.active = true;
            requestAnimationFrame(engineLoop);
        }

        function initSensors() {
            window.addEventListener('devicemotion', onMotion);
            window.addEventListener('deviceorientation', onOrient);
        }

        // --- 2. é€Ÿåº¦å¼•æ“ V8 (è§£å†³å¡æ­»çš„æ ¸å¿ƒ) ---
        function onMotion(e) {
            const acc = e.accelerationIncludingGravity || e.acceleration;
            if(!acc) return;
            const val = Math.sqrt(acc.x**2 + acc.y**2 + acc.z**2);
            
            if (Math.abs(val - 9.8) > cfg.sens) {
                stepTrigger();
            }
        }

        function stepTrigger() {
            const now = Date.now();
            
            // å¦‚æœç³»ç»Ÿå¤„äº IDLE çŠ¶æ€ (å·²åœè½¦)ï¼Œè¿™æ˜¯å”¤é†’çš„ç¬¬ä¸€æ­¥
            if (state.isIdle) {
                // === å¼¹å°„èµ·æ­¥ ===
                state.isIdle = false; // é€€å‡ºç©ºé—²
                state.hist = [];      // æ¸…ç©ºæ‰€æœ‰å†å²æ—§æ•°æ®
                state.lastT = now;    // é‡ç½®æ—¶é—´æˆ³
                state.steps++;
                
                feedback();
                
                // å¼ºåˆ¶ç»™äºˆä¸€ä¸ªâ€œæ…¢è·‘â€çš„åˆé€Ÿåº¦ (çº¦ 4km/h)
                // è¿™æ ·è§†é¢‘ç¬é—´å°±ä¼šåŠ¨ï¼Œç»ä¸ä¼šå¡åœ¨ 0.1
                const startUpSpeed = 4.0; 
                state.targetRate = startUpSpeed / cfg.base;
                
                // ç›´æ¥èµ‹å€¼ï¼Œè·³è¿‡å¹³æ»‘è¿‡æ¸¡ï¼Œç«‹å³å“åº”
                state.currRate = state.targetRate;
                
                return; // ç¬¬ä¸€æ­¥å¤„ç†å®Œæ¯•
            }

            // å¦‚æœä¸æ˜¯ IDLEï¼Œè¯´æ˜æ˜¯è¿ç»­è¡Œèµ°
            const diff = now - state.lastT;
            if (diff < 250) return; // é˜²æŠ–

            state.steps++;
            state.lastT = now;
            feedback();

            // è®¡ç®—ç¬æ—¶æ­¥é¢‘ (SPM)
            const spm = 60000 / diff;
            state.hist.push(spm);
            if(state.hist.length > 3) state.hist.shift();

            // å–å¹³å‡å€¼
            let sum = 0;
            state.hist.forEach(v => sum += v);
            const avgSpm = sum / state.hist.length;

            // ç‰©ç†å…¬å¼
            const kmh = (avgSpm * cfg.stride * 60) / 1000;
            state.targetRate = kmh / cfg.base;
        }

        function feedback() {
            if(navigator.vibrate) navigator.vibrate(15);
            if(audioCtx && audioCtx.state === 'running') {
                const o = audioCtx.createOscillator();
                const g = audioCtx.createGain();
                o.connect(g); g.connect(audioCtx.destination);
                o.frequency.setValueAtTime(100, audioCtx.currentTime);
                o.frequency.exponentialRampToValueAtTime(0.01, audioCtx.currentTime+0.1);
                g.gain.setValueAtTime(0.2, audioCtx.currentTime);
                g.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime+0.1);
                o.start(); o.stop(audioCtx.currentTime+0.1);
            }
        }

        // --- 3. å¾ªç¯ä¸è‡ªåŠ¨åœè½¦ ---
        function engineLoop() {
            if(!state.active) return;

            // æ£€æŸ¥æ˜¯å¦åº”è¯¥åœè½¦
            // å¦‚æœ 1.5ç§’ å†…æ²¡æœ‰æ–°æ­¥æ•°
            if (!state.isIdle && Date.now() - state.lastT > 1500) {
                // === å¼ºåˆ¶å½’é›¶ ===
                state.targetRate = 0;
                state.isIdle = true; // æ ‡è®°ä¸ºç©ºé—²ï¼Œä¸ºä¸‹ä¸€æ¬¡â€œå¼¹å°„èµ·æ­¥â€åšå‡†å¤‡
                state.hist = [];     // æ—¢ç„¶åœäº†ï¼Œå†å²æ•°æ®å°±ä½œåºŸ
            }

            // å¹³æ»‘è¿‡æ¸¡
            const err = state.targetRate - state.currRate;
            if (Math.abs(err) > 0.01) {
                state.currRate += err * 0.1; 
            } else {
                state.currRate = state.targetRate;
            }

            // æ’­æ”¾é€»è¾‘
            // é˜ˆå€¼è®¾ä½ä¸€ç‚¹ï¼Œé˜²æ­¢è¿˜æ²¡åœç¨³å°±å¡ä½
            if (state.currRate > 0.02) {
                vid.playbackRate = state.currRate;
                if(vid.paused) vid.play().catch(()=>{});
            } else {
                if(!vid.paused) vid.pause();
                state.currRate = 0; 
            }

            renderUI();
            requestAnimationFrame(engineLoop);
        }

        function renderUI() {
            const kmh = state.currRate * cfg.base;
            document.getElementById('ui-spd').innerText = kmh.toFixed(1);
            document.getElementById('ui-rate').innerText = state.currRate.toFixed(2) + " x";
            
            document.getElementById('ui-step').innerText = state.steps;
            const dist = (state.steps * cfg.stride) / 1000;
            document.getElementById('ui-dist').innerText = dist.toFixed(2) + " km";

            if(vid.duration) {
                const p = (vid.currentTime / vid.duration) * 100;
                document.getElementById('p-bar').style.width = p + "%";
                document.getElementById('t-cur').innerText = fmt(vid.currentTime);
                document.getElementById('t-all').innerText = fmt(vid.duration);
            }
        }

        // --- 4. VR ---
        function onOrient(e) {
            if(!state.isLandscape || !e.alpha) return;
            if(state.baseAlpha === null) state.baseAlpha = e.alpha;

            let d = e.alpha - state.baseAlpha;
            if(d > 180) d -= 360;
            if(d < -180) d += 360;
            d = Math.max(-cfg.vrMax, Math.min(cfg.vrMax, d));
            
            // å·¦è½¬å¤´(d<0) -> ç”»é¢å‘å³ç§»(translate>0) -> ç³»æ•°åº”ä¸ºè´Ÿ
            const pct = d * -0.8; 
            vid.style.transform = `translateX(${pct}%)`;
        }

        // --- è¾…åŠ© ---
        function toggleDrawer() { document.getElementById('drawer').classList.toggle('active'); }
        function setCfg(k,v) {
            v=parseFloat(v);
            if(k==='base') { cfg.base=v; document.getElementById('v-base').innerText=v+" km/h"; }
            if(k==='stride') { cfg.stride=v; document.getElementById('v-stride').innerText=v.toFixed(2)+" m"; }
            if(k==='sens') { cfg.sens=v; document.getElementById('v-sens').innerText=v; }
        }
        function fmt(s) { const m=Math.floor(s/60), sc=Math.floor(s%60); return `${m}:${sc<10?'0'+sc:sc}`; }
        function forceStep() { stepTrigger(); }

    </script>
</body>
</html>
