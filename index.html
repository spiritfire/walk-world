<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ¼«æ­¥ V6 - ç‰©ç†å¼•æ“ä¿®æ­£ç‰ˆ</title>
    <style>
        /* --- å…¨å±€æ ·å¼ --- */
        body, html {
            margin: 0; padding: 0; width: 100%; height: 100%;
            background: #000; overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, Roboto, sans-serif;
            -webkit-user-select: none; user-select: none;
            color: white;
        }

        /* è§†é¢‘å±‚ï¼šåªåšä½ç§»ï¼Œä¸åšç¼©æ”¾ */
        #video-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 1; display: flex; align-items: center; justify-content: center;
            overflow: hidden;
        }
        video {
            width: 100%; height: 100%; object-fit: cover;
            /* ç¨å¾®æ”¾å¤§ä¸€ç‚¹ç‚¹(105%)ä»¥å…è®¸VRè½»å¾®åç§»è€Œä¸éœ²é»‘è¾¹ï¼Œä½†ä¸åƒä¹‹å‰ç¼©æ”¾é‚£ä¹ˆå¤§ */
            width: 105%; height: 105%; 
            transition: transform 0.1s linear;
        }

        /* UI å±‚ï¼šå…¨é€æ˜ï¼Œæ–‡å­—å¸¦é˜´å½± */
        #ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 10; pointer-events: none;
            display: flex; flex-direction: column; justify-content: space-between;
        }

        .hud-text {
            color: #fff;
            text-shadow: 0 2px 4px rgba(0,0,0,0.8), 0 0 10px rgba(0,0,0,0.5);
        }

        /* é¡¶éƒ¨ä»ªè¡¨ */
        .top-bar {
            padding: 25px; display: flex; justify-content: space-between; align-items: flex-start;
        }
        .stat-box { display: flex; flex-direction: column; }
        .stat-right { text-align: right; }
        
        .val-main { font-size: 48px; font-weight: 800; line-height: 0.9; font-variant-numeric: tabular-nums; }
        .val-label { font-size: 14px; opacity: 0.9; font-weight: bold; margin-top: 5px; }
        .val-sub { font-size: 14px; color: #00e676; font-weight: bold; margin-top: 4px; text-shadow: 1px 1px 2px black; }

        /* åº•éƒ¨æ§åˆ¶ */
        .bottom-bar {
            padding: 25px; pointer-events: auto;
            display: flex; flex-direction: column; gap: 10px;
        }

        /* è¿›åº¦æ¡ */
        .progress-track {
            width: 100%; height: 8px; background: rgba(255,255,255,0.3);
            border-radius: 4px; overflow: hidden; backdrop-filter: blur(5px);
        }
        .progress-fill {
            height: 100%; width: 0%; background: #00e676;
            box-shadow: 0 0 10px rgba(0,230,118,0.8);
            transition: width 0.2s linear;
        }
        .time-label { text-align: right; font-size: 12px; margin-bottom: 5px; }

        /* è®¾ç½®é¢æ¿ (ä¸Šæ‹‰æŠ½å±‰) */
        #settings-drawer {
            position: absolute; bottom: 0; left: 0; width: 100%;
            background: rgba(18, 18, 18, 0.98);
            border-top: 1px solid #333; border-radius: 20px 20px 0 0;
            padding: 25px; box-sizing: border-box;
            transform: translateY(110%); transition: transform 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 20; pointer-events: auto; color: white;
        }
        #settings-drawer.open { transform: translateY(0); }

        .cfg-row { margin-bottom: 25px; }
        .cfg-header { display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 14px; color: #ccc; }
        .cfg-val { color: #00e676; font-weight: bold; }
        input[type=range] { width: 100%; height: 6px; background: #444; border-radius: 3px; -webkit-appearance: none; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; width: 20px; height: 20px; background: #fff; border-radius: 50%; box-shadow: 0 2px 5px black; }

        /* å¯åŠ¨é®ç½© */
        #start-mask {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 100;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .btn {
            background: #333; border: 1px solid #555; color: white; padding: 12px 25px;
            border-radius: 30px; font-size: 16px; font-weight: bold; margin: 10px; cursor: pointer;
        }
        .btn-green { background: #00e676; color: black; border: none; }
        .btn-blue { background: #2196F3; border: none; }
        .btn-sets { background: rgba(0,0,0,0.4); border: 1px solid rgba(255,255,255,0.3); align-self: flex-end; font-size: 12px; padding: 8px 16px; backdrop-filter: blur(4px); }

    </style>
</head>
<body>

    <!-- å¯åŠ¨é¡µ -->
    <div id="start-mask">
        <h1 style="color:#00e676; margin-bottom: 10px;">ğŸƒ æ¼«æ­¥ V6</h1>
        <p style="color:#888; font-size:12px; margin-bottom: 40px;">ç‰©ç†ä¿®æ­£ Â· æ™ºèƒ½èµ·æ­¥ Â· VRæ ¡å‡†</p>
        
        <button class="btn btn-blue" onclick="document.getElementById('file-in').click()">1. é€‰æ‹©è·¯çº¿è§†é¢‘</button>
        <input type="file" id="file-in" accept="video/*" style="display:none" onchange="onFile(this)">
        <div id="file-msg" style="color:#00e676; font-size:12px; height:20px; margin-bottom:20px;"></div>
        
        <button id="btn-go" class="btn btn-green" onclick="go()" disabled style="opacity:0.5">2. å…¨å±å‡ºå‘</button>
    </div>

    <!-- è§†é¢‘ -->
    <div id="video-layer">
        <video id="vid" playsinline loop muted webkit-playsinline></video>
    </div>

    <!-- HUD -->
    <div id="ui-layer" style="display:none;">
        <div class="top-bar">
            <div class="stat-box hud-text">
                <div class="val-main" id="ui-speed">0.0</div>
                <div class="val-label">æ—¶é€Ÿ (km/h)</div>
                <div class="val-sub" id="ui-rate">x 0.0</div>
            </div>
            <div class="stat-box stat-right hud-text">
                <div class="val-main" id="ui-steps">0</div>
                <div class="val-label">æ­¥æ•°</div>
                <div class="val-sub" id="ui-dist">0.00 km</div>
            </div>
        </div>

        <div class="bottom-bar">
            <div class="time-label hud-text"><span id="t-cur">0:00</span> / <span id="t-dur">0:00</span></div>
            <div class="progress-track">
                <div class="progress-fill" id="p-bar"></div>
            </div>
            <button class="btn btn-sets hud-text" onclick="toggleSet()">âš™ï¸ è®¾ç½®</button>
        </div>
    </div>

    <!-- è®¾ç½® -->
    <div id="settings-drawer">
        <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
            <h3>è¿åŠ¨è®¾ç½®</h3>
            <button onclick="toggleSet()" style="background:none; border:none; color:#888; font-size:24px;">Ã—</button>
        </div>

        <div class="cfg-row">
            <div class="cfg-header"><span>åŸè§†é¢‘é€Ÿåº¦</span><span class="cfg-val" id="val-base">5 km/h</span></div>
            <input type="range" min="2" max="20" value="5" oninput="setCfg('base', this.value)">
        </div>
        
        <div class="cfg-row">
            <div class="cfg-header"><span>æˆ‘çš„æ­¥é•¿</span><span class="cfg-val" id="val-stride">0.70 m</span></div>
            <input type="range" min="0.4" max="1.2" step="0.05" value="0.7" oninput="setCfg('stride', this.value)">
        </div>

        <div class="cfg-row">
            <div class="cfg-header"><span>ä¼ æ„Ÿå™¨çµæ•åº¦ (è¶Šå°è¶Šçµæ•)</span><span class="cfg-val" id="val-sens">1.5</span></div>
            <input type="range" min="0.5" max="5.0" step="0.1" value="1.5" oninput="setCfg('sens', this.value)">
        </div>

        <div style="margin-top:20px; border-top:1px solid #333; padding-top:15px; text-align:center;">
             <button class="btn" onclick="testStep()">ğŸ§ª æ¨¡æ‹Ÿä¸€æ­¥ (æµ‹è¯•)</button>
        </div>
    </div>

    <script>
        // --- ç³»ç»Ÿå˜é‡ ---
        const cfg = {
            baseSpeed: 5,     // è§†é¢‘åŸºå‡†é€Ÿåº¦
            stride: 0.7,      // æ­¥é•¿
            sens: 1.5,        // çµæ•åº¦
            vrMax: 20         // VRæœ€å¤§åè½¬è§’åº¦
        };

        const state = {
            running: false,
            steps: 0,
            lastStepT: 0,
            
            // é€Ÿåº¦è®¡ç®—ä¸“ç”¨å˜é‡
            stepIntervals: [], // å­˜å‚¨æœ€è¿‘3æ¬¡æ­¥é•¿é—´éš”ï¼Œç”¨äºå–å¹³å‡å€¼
            
            currRate: 0,
            targetRate: 0,
            
            isLandscape: false,
            initAlpha: null
        };

        const vid = document.getElementById('vid');
        let audioCtx;

        // --- 1. å¯åŠ¨ä¸æ–‡ä»¶ ---
        function onFile(el) {
            const f = el.files[0];
            if(!f) return;
            vid.src = URL.createObjectURL(f);
            document.getElementById('file-msg').innerText = f.name;
            document.getElementById('btn-go').disabled = false;
            document.getElementById('btn-go').style.opacity = 1;

            vid.onloadedmetadata = () => {
                state.isLandscape = vid.videoWidth > vid.videoHeight;
                if(state.isLandscape) {
                    vid.style.width = 'auto'; vid.style.height = '100vh';
                } else {
                    vid.style.width = '100%'; vid.style.height = '100%';
                }
            };
        }

        function go() {
            if(document.documentElement.requestFullscreen) document.documentElement.requestFullscreen();
            document.getElementById('start-mask').style.display = 'none';
            document.getElementById('ui-layer').style.display = 'flex';
            
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();

            // æƒé™è¯·æ±‚
            if (typeof DeviceMotionEvent !== 'undefined' && typeof DeviceMotionEvent.requestPermission === 'function') {
                DeviceMotionEvent.requestPermission().then(r => { if(r==='granted') initSensors(); });
            } else {
                initSensors();
            }

            // é¢„çƒ­è§†é¢‘
            vid.play().then(() => vid.pause()).catch(()=>{});
            
            state.running = true;
            requestAnimationFrame(loop);
        }

        function initSensors() {
            window.addEventListener('devicemotion', onMotion);
            window.addEventListener('deviceorientation', onOrient);
        }

        // --- 2. ç‰©ç†æ ¸å¿ƒ (é€Ÿåº¦è®¡ç®—) ---
        function onMotion(e) {
            const acc = e.accelerationIncludingGravity || e.acceleration;
            if(!acc) return;
            const val = Math.sqrt(acc.x**2 + acc.y**2 + acc.z**2);
            if (Math.abs(val - 9.8) > cfg.sens) triggerStep();
        }

        function triggerStep() {
            const now = Date.now();
            const diff = now - state.lastStepT;

            // é˜²æŠ–ï¼š250ms (æœ€å¿«æ­¥é¢‘ 240/min)
            if(diff < 250) return;

            // åé¦ˆ
            feedback();
            state.steps++;
            
            // æ ¸å¿ƒé€»è¾‘ï¼šè®¡ç®—é€Ÿåº¦
            // åˆ¤æ–­æ˜¯å¦æ˜¯å†·å¯åŠ¨ (åœæ­¢è¶…è¿‡1.5ç§’)
            if (diff > 1500) {
                // [ä¿®å¤èµ·æ­¥æ…¢]ï¼šè¿™æ˜¯ç¬¬ä¸€æ­¥ï¼Œæ— æ³•è®¡ç®—é—´éš”ã€‚
                // å¼ºåˆ¶ç»™äºˆä¸€ä¸ªåˆç†çš„å¯åŠ¨é€Ÿåº¦ (ä¾‹å¦‚ 4km/h) è®©è§†é¢‘ç«‹å³åŠ¨èµ·æ¥
                const startSpeed = 4.0; 
                state.targetRate = startSpeed / cfg.baseSpeed;
                
                // å¼ºåˆ¶é‡ç½®å½“å‰é€Ÿç‡ï¼Œè·³è¿‡å¹³æ»‘è¿‡æ¸¡
                state.currRate = state.targetRate;
                
                // æ¸…ç©ºå†å²è®°å½•
                state.stepIntervals = []; 
            } else {
                // è¿ç»­è¡Œèµ°ï¼šå­˜å…¥ buffer è®¡ç®—å¹³å‡å€¼
                state.stepIntervals.push(diff);
                if(state.stepIntervals.length > 3) state.stepIntervals.shift(); // åªä¿ç•™æœ€è¿‘3ä¸ª

                // è®¡ç®—å¹³å‡é—´éš”
                let sum = 0;
                state.stepIntervals.forEach(t => sum += t);
                const avgDiff = sum / state.stepIntervals.length;

                // ç‰©ç†å…¬å¼ï¼š
                // æ­¥é¢‘(æ¬¡/ç§’) = 1000 / avgDiff
                // é€Ÿåº¦(ç±³/ç§’) = æ­¥é¢‘ * æ­¥é•¿
                // æ—¶é€Ÿ(km/h) = é€Ÿåº¦ * 3.6
                const stepsPerSec = 1000 / avgDiff;
                const speedKmh = stepsPerSec * cfg.stride * 3.6;

                state.targetRate = speedKmh / cfg.baseSpeed;
            }

            state.lastStepT = now;
        }

        function feedback() {
            if(navigator.vibrate) navigator.vibrate(15);
            if(audioCtx && audioCtx.state === 'running') {
                const o = audioCtx.createOscillator();
                const g = audioCtx.createGain();
                o.connect(g); g.connect(audioCtx.destination);
                o.frequency.setValueAtTime(100, audioCtx.currentTime);
                o.frequency.exponentialRampToValueAtTime(0.01, audioCtx.currentTime+0.1);
                g.gain.setValueAtTime(0.2, audioCtx.currentTime);
                g.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime+0.1);
                o.start(); o.stop(audioCtx.currentTime+0.1);
            }
        }

        // --- 3. VR ä¿®æ­£ (æ–¹å‘ä¿®æ­£) ---
        function onOrient(e) {
            if(!state.isLandscape || !e.alpha) return;
            if(state.initAlpha === null) state.initAlpha = e.alpha;

            let d = e.alpha - state.initAlpha;
            if(d > 180) d -= 360;
            if(d < -180) d += 360;

            // é™åˆ¶è§’åº¦ (-20 ~ 20)
            d = Math.max(-cfg.vrMax, Math.min(cfg.vrMax, d));

            // [ä¿®å¤]ï¼šæ–¹å‘åè½¬
            // å¦‚æœ d æ˜¯æ­£æ•°(å‘å³è½¬)ï¼Œæˆ‘ä»¬éœ€è¦å‘å·¦å¹³ç§»ç”»é¢(translateXè´Ÿ)
            // æ‰€ä»¥è¿™é‡Œç”¨ æ­£ç›¸å…³ (+d) è¿˜æ˜¯ è´Ÿç›¸å…³ (-d)ï¼Ÿ
            // ä¹‹å‰çš„ç‰ˆæœ¬æ‚¨è¯´åäº†ã€‚
            // å‡è®¾ï¼šå‘å·¦è½¬(d < 0)ã€‚å¦‚æœæˆ‘æƒ³çœ‹å·¦è¾¹ï¼Œç”»é¢åº”è¯¥å‘å³å¹³ç§»(Translate > 0)ã€‚
            // ä¹‹å‰æ˜¯ -(d)ã€‚ d<0 -> -d>0 -> Translate>0. (ç†è®ºæ˜¯å¯¹çš„ï¼Œä½†æ‚¨è¯´åäº†)
            // é‚£ä¹ˆç°åœ¨æˆ‘æ”¹æˆ æ­£ç›¸å…³ã€‚
            // å‘å·¦è½¬(d<0) -> Translate < 0 (ç”»é¢å‘å·¦ç§») -> æ˜¾ç¤ºçš„æ˜¯ç”»é¢çš„å³ä¾§ã€‚
            // è¯•ä¸€ä¸‹è¿™ä¸ªé€»è¾‘ã€‚
            const pct = (d / cfg.vrMax) * 15; 
            
            vid.style.transform = `translateX(${pct}%)`;
        }

        // --- 4. ä¸»å¾ªç¯ ---
        function loop() {
            if(!state.running) return;

            // è‡ªåŠ¨åœè½¦ (è¶…è¿‡1.5ç§’æ— æ­¥æ•°)
            if (Date.now() - state.lastStepT > 1500) {
                state.targetRate = 0;
            }

            // å¹³æ»‘è¿‡æ¸¡ (Lerp)
            // å¢åŠ ååº”é€Ÿåº¦ç³»æ•°åˆ° 0.15
            const diff = state.targetRate - state.currRate;
            if (Math.abs(diff) > 0.01) {
                state.currRate += diff * 0.15;
            } else {
                state.currRate = state.targetRate;
            }

            // æ’­æ”¾å™¨æ§åˆ¶
            if(state.currRate > 0.05) {
                vid.playbackRate = state.currRate;
                if(vid.paused) vid.play().catch(e=>{});
            } else {
                if(!vid.paused) vid.pause();
                state.currRate = 0; // å½»åº•å½’é›¶
            }

            drawUI();
            requestAnimationFrame(loop);
        }

        function drawUI() {
            const realSpeed = state.currRate * cfg.baseSpeed;
            document.getElementById('ui-speed').innerText = realSpeed.toFixed(1);
            document.getElementById('ui-rate').innerText = "x " + state.currRate.toFixed(2);
            
            document.getElementById('ui-steps').innerText = state.steps;
            const dist = (state.steps * cfg.stride) / 1000;
            document.getElementById('ui-dist').innerText = dist.toFixed(2) + " km";

            if(vid.duration) {
                const p = (vid.currentTime / vid.duration) * 100;
                document.getElementById('p-bar').style.width = p + "%";
                document.getElementById('t-cur').innerText = fmt(vid.currentTime);
                document.getElementById('t-dur').innerText = fmt(vid.duration);
            }
        }

        // --- è¾…åŠ© ---
        function setCfg(k, v) {
            v = parseFloat(v);
            if(k==='base') { cfg.baseSpeed = v; document.getElementById('val-base').innerText = v+" km/h"; }
            if(k==='stride') { cfg.stride = v; document.getElementById('val-stride').innerText = v.toFixed(2)+" m"; }
            if(k==='sens') { cfg.sens = v; document.getElementById('val-sens').innerText = v; }
        }
        function toggleSet() {
            document.getElementById('settings-drawer').classList.toggle('open');
        }
        function fmt(s) {
            const m = Math.floor(s/60);
            const sc = Math.floor(s%60);
            return `${m}:${sc<10?'0'+sc:sc}`;
        }
        function testStep() { triggerStep(); } // è°ƒè¯•ç”¨

    </script>
</body>
</html>
