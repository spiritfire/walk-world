<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ¼«æ­¥ V13 - å¼ºåŠ›å½’é›¶ç‰ˆ</title>
    <style>
        /* --- å…¨å±€ --- */
        body, html { margin:0; padding:0; width:100%; height:100%; background:#000; overflow:hidden; font-family:-apple-system, BlinkMacSystemFont, Roboto, sans-serif; user-select:none; -webkit-tap-highlight-color:transparent; color:white; }
        
        /* è§†é¢‘ï¼šå¹³æ»‘ä½ç§» */
        #v-wrap { position:absolute; top:0; left:0; width:100%; height:100%; z-index:1; display:flex; align-items:center; justify-content:center; }
        video { width:100%; height:100%; object-fit:cover; transition:transform 0.1s cubic-bezier(0.25, 0.46, 0.45, 0.94); }

        /* UIå±‚ */
        #ui { position:absolute; top:0; left:0; width:100%; height:100%; z-index:10; pointer-events:none; display:flex; flex-direction:column; justify-content:space-between; text-shadow:0 2px 8px rgba(0,0,0,1); }
        
        /* é¡¶éƒ¨ */
        .top { padding:25px; display:flex; justify-content:space-between; align-items:flex-start; }
        .grp { display:flex; flex-direction:column; }
        .grp-r { text-align:right; align-items:flex-end; }
        
        .txt-main { font-size:60px; font-weight:900; line-height:0.9; font-variant-numeric:tabular-nums; }
        .txt-lbl { font-size:12px; font-weight:700; color:#ccc; margin-top:5px; text-transform:uppercase; letter-spacing:1px; }
        .txt-sub { font-size:18px; font-weight:700; color:#00e676; margin-top:5px; }

        /* å‘¼å¸ç‚¹ */
        .dot { display:inline-block; width:12px; height:12px; background:#444; border-radius:50%; margin-right:8px; border:1px solid #888; transition:0.1s; }
        .dot.lit { background:#00e676; box-shadow:0 0 15px #00e676; border-color:#fff; transform:scale(1.4); }

        /* åº•éƒ¨ */
        .btm { padding:25px; pointer-events:auto; background:linear-gradient(to top, rgba(0,0,0,0.95), transparent); }
        .bar-bg { width:100%; height:8px; background:rgba(255,255,255,0.2); border-radius:4px; overflow:hidden; backdrop-filter:blur(5px); }
        .bar-fg { width:0%; height:100%; background:#00e676; box-shadow:0 0 15px rgba(0,230,118,0.6); transition:width 0.2s linear; }
        .tm { display:flex; justify-content:space-between; font-size:12px; margin-bottom:10px; font-weight:600; opacity:0.8; }
        
        .btn-row { display:flex; justify-content:space-between; margin-top:20px; gap:10px; }

        /* è®¾ç½®æŠ½å±‰ */
        #set { position:absolute; bottom:0; left:0; width:100%; background:rgba(15,15,15,0.98); border-top:1px solid #333; border-radius:24px 24px 0 0; padding:30px; box-sizing:border-box; transform:translateY(110%); transition:transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1); z-index:20; pointer-events:auto; }
        #set.show { transform:translateY(0); }
        
        .row { margin-bottom:25px; }
        .rh { display:flex; justify-content:space-between; margin-bottom:12px; font-size:14px; color:#aaa; font-weight:600; }
        .rv { color:#00e676; }
        input[type=range] { width:100%; height:6px; background:#333; border-radius:3px; -webkit-appearance:none; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance:none; width:24px; height:24px; background:#fff; border-radius:50%; box-shadow:0 4px 8px rgba(0,0,0,0.6); }
        
        .tgl-row { display:flex; align-items:center; justify-content:space-between; margin-bottom:20px; font-size:14px; color:#ddd; font-weight:600; }
        .tgl { width:52px; height:30px; background:#444; border-radius:15px; position:relative; transition:0.3s; cursor:pointer; }
        .tgl::after { content:''; position:absolute; top:2px; left:2px; width:26px; height:26px; background:#fff; border-radius:50%; transition:0.3s; box-shadow:0 1px 3px rgba(0,0,0,0.3); }
        .tgl.on { background:#00e676; }
        .tgl.on::after { left:24px; }

        /* å¯åŠ¨é¡µ */
        #boot { position:absolute; top:0; left:0; width:100%; height:100%; background:#050505; z-index:99; display:flex; flex-direction:column; align-items:center; justify-content:center; }
        .btn { padding:18px 45px; border-radius:50px; font-size:18px; font-weight:700; border:none; margin:15px; cursor:pointer; transition:transform 0.1s; }
        .btn:active { transform:scale(0.95); }
        .btn-g { background:#00e676; color:#000; box-shadow:0 0 20px rgba(0,230,118,0.3); }
        .btn-b { background:#2979FF; color:#fff; }
        .btn-s { flex:1; background:rgba(255,255,255,0.08); border:1px solid rgba(255,255,255,0.2); color:#fff; padding:12px; font-size:14px; border-radius:16px; backdrop-filter:blur(10px); display:flex; align-items:center; justify-content:center; }
        .btn-s:active { background:rgba(255,255,255,0.2); }

    </style>
</head>
<body>

    <div id="boot">
        <h1 style="color:#00e676; margin-bottom:10px;">ğŸƒ æ¼«æ­¥ V13</h1>
        <p style="color:#666; font-size:12px; margin-bottom:50px; letter-spacing:1px;">å¼ºåŠ›å½’é›¶ Â· ç¬æ—¶å“åº”</p>
        <button class="btn btn-b" onclick="document.getElementById('fi').click()">1. é€‰æ‹©è§†é¢‘</button>
        <input type="file" id="fi" accept="video/*" style="display:none" onchange="onF(this)">
        <div id="fn" style="color:#00e676; font-size:12px; height:20px;"></div>
        <button id="go" class="btn btn-g" onclick="start()" disabled style="opacity:0.3">2. å…¨å±å‡ºå‘</button>
    </div>

    <div id="v-wrap"><video id="vid" playsinline loop muted webkit-playsinline></video></div>

    <div id="ui" style="display:none">
        <div class="top">
            <div class="grp">
                <div class="txt-main" id="d-spd">0.0</div>
                <div class="txt-lbl">æ—¶é€Ÿ km/h</div>
                <div class="txt-sub" id="d-rat">0.00 x</div>
            </div>
            <div class="grp grp-r">
                <div class="txt-main" id="d-stp">0</div>
                <div class="txt-lbl"><span class="dot" id="dot"></span>æ­¥æ•°</div>
                <div class="txt-sub" id="d-dst">0.00 km</div>
            </div>
        </div>
        <div class="btm">
            <div class="tm"><span id="tc">0:00</span><span id="tt">0:00</span></div>
            <div class="bar-bg"><div class="bar-fg" id="pb"></div></div>
            
            <div class="btn-row">
                <button class="btn-s" onclick="recenter()">ğŸ¯ å›æ­£è§†è§’</button>
                <button class="btn-s" onclick="tSet()">âš™ï¸ è®¾ç½®</button>
            </div>
        </div>
    </div>

    <div id="set">
        <div style="display:flex;justify-content:space-between;margin-bottom:30px;align-items:center;">
            <h3 style="margin:0">è®¾ç½®</h3>
            <span onclick="tSet()" style="font-size:28px;color:#666;cursor:pointer;">Ã—</span>
        </div>

        <div class="row"><div class="rh"><span>åŸè§†é¢‘é€Ÿåº¦</span><span class="rv" id="vb">5 km/h</span></div><input type="range" min="2" max="15" value="5" oninput="uC('base',this.value)"></div>
        <div class="row"><div class="rh"><span>æˆ‘çš„æ­¥é•¿</span><span class="rv" id="vs">0.70 m</span></div><input type="range" min="0.4" max="1.2" step="0.05" value="0.7" oninput="uC('stride',this.value)"></div>
        <div class="row"><div class="rh"><span>çµæ•åº¦ (1=æœ€çµæ•)</span><span class="rv" id="vse">1.3</span></div><input type="range" min="0.8" max="3.0" step="0.1" value="1.3" oninput="uC('sens',this.value)"></div>
        
        <div style="height:1px; background:#333; margin:25px 0;"></div>
        
        <div class="tgl-row" onclick="uT('vrInv')">
            <span>ğŸ”„ VR æ–¹å‘åè½¬</span>
            <div class="tgl" id="t-vr"></div>
        </div>

        <div style="text-align:center; margin-top:30px;">
             <button class="btn-s" style="width:100%; border-color:#00e676; color:#00e676;" onclick="sim()">âš¡ æ¨¡æ‹Ÿè§¦å‘ (æµ‹è¯•)</button>
        </div>
    </div>

    <script>
        // --- æ ¸å¿ƒé…ç½® ---
        const C = { base:5, stride:0.7, sens:1.3, vr:25, vrInv:false };
        const S = { 
            run:false, steps:0, 
            lastT:0,      
            hist:[],      
            curr:0, target:0, 
            land:false, alpha0:null 
        };
        
        const vid = document.getElementById('vid');
        const dot = document.getElementById('dot');
        let ac; 

        function onF(el) {
            const f=el.files[0]; if(!f)return;
            vid.src=URL.createObjectURL(f);
            document.getElementById('fn').innerText=f.name;
            document.getElementById('go').disabled=false;
            document.getElementById('go').style.opacity=1;
            vid.onloadedmetadata = () => {
                S.land = vid.videoWidth > vid.videoHeight;
                if(S.land) { vid.style.width='auto'; vid.style.height='100vh'; } 
                else { vid.style.width='100%'; vid.style.height='100%'; }
            };
        }

        function start() {
            if(document.documentElement.requestFullscreen) document.documentElement.requestFullscreen();
            document.getElementById('boot').style.display='none';
            document.getElementById('ui').style.display='flex';
            ac = new (window.AudioContext||window.webkitAudioContext)();
            if(window.DeviceMotionEvent && typeof DeviceMotionEvent.requestPermission==='function') {
                DeviceMotionEvent.requestPermission().then(r=>{if(r==='granted')init();});
            } else init();
            vid.play().then(()=>vid.pause());
            S.run=true;
            requestAnimationFrame(loop);
        }

        function init() {
            window.addEventListener('devicemotion', mot);
            window.addEventListener('deviceorientation', ori);
        }

        // --- è¿åŠ¨å¼•æ“ V13 ---
        function mot(e) {
            const a = e.accelerationIncludingGravity || e.acceleration;
            if(!a) return;
            const v = Math.sqrt(a.x**2 + a.y**2 + a.z**2);
            if(Math.abs(v - 9.8) > C.sens) trig();
        }

        function trig() {
            const now = Date.now();
            const diff = now - S.lastT;

            if(diff < 250) return;

            // åé¦ˆ
            dot.classList.add('lit');
            setTimeout(()=>dot.classList.remove('lit'), 100);
            fb(); 

            S.steps++;
            
            // åˆ¤å®šï¼šå¦‚æœè·ç¦»ä¸Šæ¬¡è§¦å‘è¶…è¿‡ 1.2ç§’ï¼Œè§†ä¸ºâ€œæ–°èµ·æ­¥â€
            // (ä¹‹å‰æ˜¯2.0ç§’ï¼Œç°åœ¨æ”¹çŸ­ï¼Œé˜²æ­¢æ‹–æ²“)
            if (diff > 1200) {
                // å†·å¯åŠ¨é€»è¾‘
                const startSPM = 80; 
                S.hist = [startSPM];
                const kmh = (startSPM * C.stride * 60) / 1000;
                S.target = kmh / C.base;
                
                // å¼ºåˆ¶æå‡å½“å‰é€Ÿåº¦ï¼Œé¿å…ä»0æ…¢æ…¢çˆ¬
                if(S.curr < 0.1) S.curr = S.target * 0.6; 
                
            } else {
                // è¿ç»­è¡Œèµ°
                const spm = 60000 / diff;
                S.hist.push(spm);
                if(S.hist.length > 3) S.hist.shift();

                let sum = 0; S.hist.forEach(v=>sum+=v);
                const avgSPM = sum / S.hist.length;
                
                const kmh = (avgSPM * C.stride * 60) / 1000;
                S.target = kmh / C.base;
            }

            S.lastT = now;
        }

        function loop() {
            if(!S.run) return;

            // è‡ªåŠ¨åœè½¦æ£€æµ‹ (1.2ç§’è¶…æ—¶)
            if(Date.now() - S.lastT > 1200) {
                S.target = 0;
            }

            // å¹³æ»‘è®¡ç®—
            const d = S.target - S.curr;
            if(Math.abs(d) > 0.001) S.curr += d * 0.1;
            else S.curr = S.target;

            // === æ ¸å¿ƒä¿®å¤ V13ï¼šå¼ºåŠ›å½’é›¶ ===
            // å¦‚æœå€ç‡æ‰åˆ° 0.08 ä»¥ä¸‹ï¼Œç›´æ¥å¼ºåˆ¶è®¾ä¸º 0ã€‚
            // ç»ä¸è®©å®ƒåœç•™åœ¨ 0.07 è¿™ç§å°´å°¬æ•°å€¼ã€‚
            if(S.curr < 0.08) {
                S.curr = 0; // å¼ºåˆ¶å†™0
                if(!vid.paused) vid.pause();
            } else {
                vid.playbackRate = S.curr;
                if(vid.paused) vid.play().catch(()=>{});
            }

            draw();
            requestAnimationFrame(loop);
        }

        function draw() {
            const kmh = S.curr * C.base;
            
            document.getElementById('d-spd').innerText = kmh.toFixed(1);
            // è¿™é‡Œ S.curr å·²ç»è¢«å¼ºåˆ¶ä¸º0äº†ï¼Œæ‰€ä»¥ UI è‚¯å®šæ˜¾ç¤º 0.00 x
            document.getElementById('d-rat').innerText = S.curr.toFixed(2)+" x";
            document.getElementById('d-stp').innerText = S.steps;
            document.getElementById('d-dst').innerText = ((S.steps*C.stride)/1000).toFixed(2)+" km";
            
            if(vid.duration) {
                document.getElementById('pb').style.width = (vid.currentTime/vid.duration*100)+"%";
                document.getElementById('tc').innerText = fmt(vid.currentTime);
                document.getElementById('tt').innerText = fmt(vid.duration);
            }
        }

        function ori(e) {
            if(!S.land || !e.alpha) return;
            if(S.alpha0 === null) S.alpha0 = e.alpha;
            
            let d = e.alpha - S.alpha0;
            if(d > 180) d -= 360; if(d < -180) d += 360;
            d = Math.max(-C.vr, Math.min(C.vr, d));
            
            let move = d * -0.8; 
            if(C.vrInv) move = move * -1;
            
            vid.style.transform = `translateX(${move}%)`;
        }
        
        function recenter() {
            S.alpha0 = null;
            vid.style.transform = `translateX(0%)`;
        }

        function fb() {
            if(navigator.vibrate) navigator.vibrate(15);
            if(ac && ac.state==='running') {
                const o=ac.createOscillator(), g=ac.createGain();
                o.connect(g); g.connect(ac.destination);
                o.frequency.setValueAtTime(100, ac.currentTime);
                o.frequency.exponentialRampToValueAtTime(0.01, ac.currentTime+0.1);
                g.gain.setValueAtTime(0.2, ac.currentTime);
                g.gain.exponentialRampToValueAtTime(0.01, ac.currentTime+0.1);
                o.start(); o.stop(ac.currentTime+0.1);
            }
        }

        function tSet() { document.getElementById('set').classList.toggle('show'); }
        function uC(k,v) { 
            v=parseFloat(v); C[k]=v;
            if(k==='base')document.getElementById('vb').innerText=v+" km/h";
            if(k==='stride')document.getElementById('vs').innerText=v.toFixed(2)+" m";
            if(k==='sens')document.getElementById('vse').innerText=v;
        }
        function uT(k) {
            C[k] = !C[k];
            if(k==='vrInv') document.getElementById('t-vr').classList.toggle('on');
        }
        function fmt(s) { return Math.floor(s/60)+":"+(Math.floor(s%60)<10?'0':'')+Math.floor(s%60); }
        function sim() { trig(); }
    </script>
</body>
</html>
